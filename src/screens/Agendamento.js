import React, { useState, useEffect } from "react"; import { useNavigate } from "react-router-dom"; // FIREBASE import { db } from "../firebase/config"; import { doc, setDoc } from "firebase/firestore"; // SUPABASE import { createClient } from '@supabase/supabase-js'; const supabase = createClient( "https://kuwsgvhjmjnhkteleczc.supabase.co", "sb_publishable_Rgq_kYySn7XB-zPyDG1_Iw_YEVt8O2P" ); export default function Agendamento() { const navigate = useNavigate(); const [destinatario, setDestinatario] = useState(""); const [telefone, setTelefone] = useState(""); const [dataEntrega, setDataEntrega] = useState(""); const [horaEntrega, setHoraEntrega] = useState(""); const [linkMensagem, setLinkMensagem] = useState(""); // LINK DO ÃUDIO const [loading, setLoading] = useState(false); useEffect(() => { // ðŸ”— Carrega o link gerado no AudioRecordPage const link = localStorage.getItem("lastRecordingUrl"); if (link) setLinkMensagem(link); }, []); const salvarAgendamento = async () => { if (!destinatario || !telefone || !dataEntrega || !horaEntrega) { alert("Preencha todos os campos."); return; } const telefoneLimpo = telefone.replace(/\D/g, ""); if (telefoneLimpo.length < 10) { alert("Telefone invÃ¡lido."); return; } if (!linkMensagem) { alert("Nenhum Ã¡udio gravado!"); return; } setLoading(true); try { // Gerar ID do pedido const orderID = AGD-${Date.now()}-${Math.random().toString(36).substr(2, 6)}; // Cliente logado previamente const clienteId = localStorage.getItem("clienteId"); const clienteNome = localStorage.getItem("clienteNome"); const telefoneRemetente = localStorage.getItem("clienteTelefone"); // Dados do agendamento const agendamento = { destinatario, telefone: telefoneLimpo, dataEntrega, horaEntrega, linkMensagem, tipo: "audio", orderID, remetenteNome: clienteNome, remetenteTelefone: telefoneRemetente, criadoEm: new Date().toISOString() }; // ðŸ”¥ Salvar no Firestore (CorujinhaLegal2) no documento do cliente if (clienteId) { const clienteRef = doc(db, "CorujinhaLegal2", clienteId); await setDoc( clienteRef, { agendamentos: { [orderID]: agendamento // salva por orderID, merge automÃ¡tico } }, { merge: true } // NÃƒO sobrescreve dados existentes do cliente ); } // ðŸ”¥ Salvar no Supabase await supabase.from("agendamentos").insert([ { data_agendamento: dataEntrega, hora_agendamento: horaEntrega + ":00", link_midia: linkMensagem, destinatario, telefone: telefoneLimpo, criado_em: new Date().toISOString(), valor: 5.00, enviado: false, order_id: orderID, Remetente: telefoneRemetente } ]); // Salvar local localStorage.setItem("lastAgendamento", JSON.stringify(agendamento)); alert("ðŸŽ‰ Agendamento salvo com sucesso!"); navigate("/saida"); } catch (error) { console.error("Erro no agendamento:", error); alert("Erro ao salvar agendamento."); } setLoading(false); }; return ( <div style={{ padding: 20 }}> <h2>ðŸ“… Agendar Entrega</h2> <div style={{ display: "grid", gap: 15, marginTop: 20 }}> <input type="text" placeholder="Nome do destinatÃ¡rio" value={destinatario} onChange={(e) => setDestinatario(e.target.value)} /> <input type="tel" placeholder="Telefone do destinatÃ¡rio (DDD + NÃºmero)" value={telefone} onChange={(e) => setTelefone(e.target.value)} /> <input type="date" value={dataEntrega} onChange={(e) => setDataEntrega(e.target.value)} /> <select value={horaEntrega} onChange={(e) => setHoraEntrega(e.target.value)} > <option value="">Selecione o horÃ¡rio</option> <option value="09:00">09:00</option> <option value="10:00">10:00</option> <option value="11:00">11:00</option> <option value="14:00">14:00</option> <option value="15:00">15:00</option> <option value="16:00">16:00</option> <option value="17:00">17:00</option> </select> </div> {linkMensagem && ( <div style={{ marginTop: 25 }}> <p>ðŸŽ§ <b>Mensagem gravada:</b></p> <audio controls src={linkMensagem} style={{ width: "100%" }} /> </div> )} <button onClick={salvarAgendamento} style={{ marginTop: 30, padding: "15px", width: "100%", background: "#28a745", color: "white", border: "none", borderRadius: "10px", fontSize: "18px", cursor: "pointer" }} disabled={loading} > {loading ? "Salvando..." : "Salvar Agendamento"} </button> </div> ); }
